<!DOCTYPE html>
<html>
<head>
    <title>Task Manager</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <h1>Task Manager</h1>
    <form id="taskForm">
        <input type="text" id="script_path" placeholder="Script Path" list="script_paths">
        <datalist id="script_paths">
            <option value="C:\Users\ytint\Desktop\fsdownload\media_group\twitter\search_last.py">
        </datalist>
        <input type="text" id="script_args" placeholder="Script Args">
        <div class="button-group">
            <button class="create-task" onclick="createTask()">Create Task</button>
            <button class="get-all-task" onclick="getAllTasks()">Get All Tasks</button>
        </div>
    </form>
    <div id="taskList">
    </div>
    <div id="resultModal" class="modal">
        <div class="clove">
            <div class="modal-header">
                <h4>任务结果</h4>
            </div>
            <div class="modal-content">
                <h5>Stdout:</h5>
                <pre id="stdout"></pre>
                <h5>Stderr:</h5>
                <pre id="stderr"></pre>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()" class="close-button">关闭</button>
            </div>
        </div>
    </div>
    <script>
        const apiUrl = 'http://localhost:8000';

        async function apiFetch(endpoint, options = {}) {
            const response = await fetch(`${apiUrl}/${endpoint}`, options);
            if (!response.ok) {
                console.error(`API fetch failed: ${response.statusText}`);
                return null;
            }
            const data = await response.json();
            return data;
        }

        function showError(message) {
            alert(`Error: ${message}`);
        }

        async function createTask() {
            const script_path = document.getElementById("script_path").value;
            const script_args = document.getElementById("script_args").value;
            const data = await apiFetch('create_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ script_path, script_args }),
            });
            if (data) {
                await getAllTasks();
            } else {
                showError('Failed to create task.');
            }
        }

        async function getAllTasks() {
            const data = await apiFetch('get_all_tasks');
            if (data) {
                populateTaskList(data);
            } else {
                showError('Failed to fetch tasks.');
            }
        }

        function populateTaskList(tasks) {
            let taskList = document.getElementById("taskList");
            taskList.innerHTML = "";
            for (let i = 0; i < tasks.length; i++) {
                let task = tasks[i];
                let taskItem = document.createElement("div");
                taskItem.className = "task-item";
                taskItem.innerHTML = `
                    <span>Task ID: ${task.id}</span>
                    <span>Script Path: ${task.script_path}</span>
                    <span>Status: ${task.status}</span>
                    <button onclick="checkTaskStatus(${task.id})">Check Status</button>
                    <button onclick="executeTask(${task.id})">执行任务</button>
                    <button onclick="getResults(${task.id})">获取结果</button>
                    <button onclick="deleteTask(${task.id})">删除任务</button>
                `;
                taskList.appendChild(taskItem);
            }
        }
        async function executeTask(taskId) {
            const data = await apiFetch(`execute_task/${taskId}`, {
                method: 'POST',
            });
            if (data) {
                console.log(data);
                await getAllTasks();
            } else {
                showError('Failed to execute task.');
            }
        }

        async function checkTaskStatus(taskId) {
            const data = await apiFetch(`check_status/${taskId}`);
            if (data) {
                console.log(data);
                await getAllTasks();
            } else {
                showError('Failed to check task status.');
            }
        }
        async function getResults(taskId) {
            const data = await apiFetch(`get_result/${taskId}`);
            if (data) {
                console.log(data);
                if(data.result){
                    document.getElementById('stdout').textContent = data.result.stdout;
                    document.getElementById('stderr').textContent = data.result.stderr;
                    showModal();
                }else{
                    showError('Failed to get task result.');
                }
            } else {
                showError('Failed to get task result.');
            }
        }
        function showModal() {
            document.getElementById('resultModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        async function deleteTask(taskId) {
            const data = await apiFetch(`delete_task/${taskId}`, {
                method: 'GET',
            });
            if (data) {
                console.log(data);
                await getAllTasks();
            } else {
                showError('Failed to delete task.');
            }
        }
        getAllTasks()
    </script>
</body>
</html>
